# 工作流测试功能文档 🧪

## 📋 概述

工作流测试功能允许你在不创建Agent的情况下，直接测试工作流的执行效果。

**主要功能：**
- ✅ 模拟工作流执行
- ✅ 实时节点状态显示
- ✅ 详细的执行结果
- ✅ 支持自定义输入数据
- ✅ 变量状态跟踪
- ✅ 错误定位和调试

---

## 🚀 如何使用

### 1. 打开测试功能

在工作流编辑器中，点击顶部工具栏的 **"测试"** 按钮。

### 2. 配置测试输入

在测试模态框中，输入JSON格式的测试数据：

```json
{
  "message": "Hello",
  "user": "Alice",
  "score": 85
}
```

**快捷示例：**
- 点击"示例1"：简单消息测试
- 点击"示例2"：带分数的测试

### 3. 开始测试

点击 **"开始测试"** 按钮，工作流将开始执行。

### 4. 查看结果

测试完成后，你可以看到：
- ✅ 每个节点的执行状态
- ✅ 最终输出结果
- ✅ 变量状态
- ✅ 节点执行详情

---

## 🎯 支持的节点类型

### 完全支持（真实执行）

#### 1. Set Variable
- 设置变量值
- 支持静态值、输入数据、表达式

#### 2. Get Variable
- 获取变量值
- 支持默认值

#### 3. If-Else
- 条件判断
- 支持4种条件类型
- 支持Else If分支

#### 4. Lambda
- 执行自定义代码
- 支持JavaScript函数

#### 5. Transform
- 数据转换
- 支持map、filter、reduce

#### 6. Filter
- 数据过滤
- 支持条件表达式

#### 7. Merge
- 数据合并
- 支持多种合并策略

#### 8. Template
- 模板渲染
- 支持变量替换

---

### 模拟支持（返回模拟结果）

以下节点类型会返回模拟结果：
- ChatModel（需要实际AI服务）
- Tool（需要实际工具调用）
- HTTP Request（需要网络请求）
- Webhook（需要外部触发）
- Retriever（需要向量数据库）

**模拟结果示例：**
```json
{
  "nodeType": "chatmodel",
  "input": {...},
  "output": "ChatModel 节点执行结果（模拟）",
  "timestamp": "2025-12-29T10:30:00.000Z"
}
```

---

## 📊 测试界面说明

### 测试输入区域

```
┌─────────────────────────────────┐
│ 测试输入数据 (JSON)             │
├─────────────────────────────────┤
│ {                               │
│   "message": "Hello",           │
│   "user": "test"                │
│ }                               │
├─────────────────────────────────┤
│ 💡 输入将作为工作流的初始数据    │
│ [示例1] [示例2]                 │
└─────────────────────────────────┘
```

### 节点执行状态

```
┌─────────────────────────────────┐
│ 节点执行状态                     │
├─────────────────────────────────┤
│ ⏸️ 设置变量    [等待]           │
│ ▶️ 条件判断    [运行中]         │
│ ✅ 数据处理    [成功]           │
│ ❌ 错误节点    [失败]           │
└─────────────────────────────────┘
```

**状态说明：**
- ⏸️ **等待**：节点尚未执行
- ▶️ **运行中**：节点正在执行
- ✅ **成功**：节点执行成功
- ❌ **失败**：节点执行失败

### 测试结果

#### 成功结果
```
┌─────────────────────────────────┐
│ ✅ 执行成功                      │
├─────────────────────────────────┤
│ 最终输出：                       │
│ {                               │
│   "result": "processed data"    │
│ }                               │
├─────────────────────────────────┤
│ 变量状态：                       │
│ {                               │
│   "user_score": 85,             │
│   "threshold": 80               │
│ }                               │
├─────────────────────────────────┤
│ 节点执行详情 (点击展开)          │
└─────────────────────────────────┘
```

#### 失败结果
```
┌─────────────────────────────────┐
│ ❌ 执行失败                      │
├─────────────────────────────────┤
│ 错误信息：                       │
│ 节点 "数据处理" 执行失败:       │
│ 代码执行错误: xxx is not defined│
└─────────────────────────────────┘
```

---

## 🎓 使用教程

### 教程1：测试简单工作流

**场景：** 测试变量设置和获取

**工作流：**
```
Set Variable
  ├─ 变量名: user_name
  └─ 值: "Alice"
  ↓
Get Variable
  ├─ 变量名: user_name
  └─ 输出字段: name
```

**测试步骤：**
1. 点击"测试"按钮
2. 输入测试数据：
   ```json
   {
     "test": true
   }
   ```
3. 点击"开始测试"
4. 查看结果：
   ```json
   {
     "name": "Alice"
   }
   ```

---

### 教程2：测试条件分支

**场景：** 测试分数评级

**工作流：**
```
Set Variable (保存分数)
  ↓
If-Else (判断等级)
  ├─ If: $score > 90 → A等级
  ├─ Else If: $score > 80 → B等级
  └─ Else: → C等级
```

**测试步骤：**
1. 在变量管理面板设置：`score = 85`
2. 点击"测试"按钮
3. 输入测试数据：
   ```json
   {
     "student": "Bob"
   }
   ```
4. 点击"开始测试"
5. 查看结果：
   - 节点状态：全部成功
   - 分支：`else_if_0`（B等级）

---

### 教程3：测试Lambda函数

**场景：** 测试数据处理

**工作流：**
```
Lambda (文本处理)
  code: |
    function process(input) {
      return {
        original: input.text,
        upper: input.text.toUpperCase(),
        length: input.text.length
      };
    }
```

**测试步骤：**
1. 点击"测试"按钮
2. 输入测试数据：
   ```json
   {
     "text": "hello world"
   }
   ```
3. 点击"开始测试"
4. 查看结果：
   ```json
   {
     "original": "hello world",
     "upper": "HELLO WORLD",
     "length": 11
   }
   ```

---

### 教程4：测试复杂工作流

**场景：** 测试数据验证和处理

**工作流：**
```
If-Else (检查邮箱)
  条件: input.email 存在
  ├─ True → Lambda (格式化)
  └─ Else → 返回错误
  ↓
Set Variable (保存结果)
  ↓
Template (生成消息)
```

**测试步骤：**
1. 点击"测试"按钮
2. 测试有效输入：
   ```json
   {
     "email": "user@example.com",
     "name": "Alice"
   }
   ```
3. 查看成功结果
4. 测试无效输入：
   ```json
   {
     "name": "Bob"
   }
   ```
5. 查看错误分支执行

---

## 💡 测试技巧

### 1. 使用变量管理面板

在测试前，在变量管理面板中预设全局变量：

```
变量管理面板：
  ├─ threshold: 80
  ├─ api_key: "test_key"
  └─ debug_mode: true
```

这样在测试时，这些变量已经可用。

### 2. 使用示例数据

点击"示例1"或"示例2"快速填充测试数据，然后根据需要修改。

### 3. 逐步测试

对于复杂工作流：
1. 先测试单个节点
2. 逐步添加节点
3. 每次添加后都测试
4. 确保每一步都正确

### 4. 查看节点详情

测试成功后，展开"节点执行详情"查看每个节点的输入输出：

```json
{
  "node_1": {
    "variable": "user_name",
    "value": "Alice"
  },
  "node_2": {
    "value": "Alice"
  }
}
```

### 5. 调试错误

如果测试失败：
1. 查看错误信息，定位失败的节点
2. 检查该节点的配置
3. 简化测试输入
4. 逐个排查问题

---

## 🔍 调试指南

### 常见错误及解决方案

#### 错误1：测试输入不是有效的JSON格式

**错误信息：**
```
测试输入不是有效的JSON格式
```

**解决方案：**
- 检查JSON语法（逗号、引号、括号）
- 使用JSON验证工具
- 点击示例按钮使用预设格式

#### 错误2：节点执行失败

**错误信息：**
```
节点 "数据处理" 执行失败: xxx is not defined
```

**解决方案：**
- 检查Lambda代码语法
- 确保引用的变量存在
- 检查输入数据结构

#### 错误3：变量未定义

**错误信息：**
```
变量 "user_score" 未定义
```

**解决方案：**
- 在变量管理面板中添加变量
- 或在工作流中先使用Set Variable设置

#### 错误4：循环依赖

**错误信息：**
```
检测到循环依赖
```

**解决方案：**
- 检查节点连接
- 确保没有形成循环
- 重新设计工作流结构

---

## 📋 测试检查清单

### 测试前
- [ ] 工作流已保存
- [ ] 所有节点已配置
- [ ] 节点连接正确
- [ ] 变量已预设（如需要）

### 测试中
- [ ] 测试输入格式正确
- [ ] 观察节点执行状态
- [ ] 注意错误提示

### 测试后
- [ ] 检查最终输出
- [ ] 验证变量状态
- [ ] 查看节点详情
- [ ] 记录测试结果

---

## 🎯 最佳实践

### 1. 准备测试数据

创建多组测试数据覆盖不同场景：

```json
// 正常情况
{"score": 85, "user": "Alice"}

// 边界情况
{"score": 100, "user": "Bob"}
{"score": 0, "user": "Charlie"}

// 异常情况
{"user": "David"}  // 缺少score
{}  // 空对象
```

### 2. 测试所有分支

对于If-Else节点，测试所有可能的分支：
- True分支
- 每个Else If分支
- Else分支

### 3. 验证变量状态

测试后检查变量状态，确保：
- 变量被正确设置
- 变量值符合预期
- 作用域正确

### 4. 记录测试结果

保存测试输入和输出，方便后续对比：

```
测试1: 正常用户
输入: {"score": 85}
输出: {"grade": "B"}
状态: ✅ 成功

测试2: 高分用户
输入: {"score": 95}
输出: {"grade": "A"}
状态: ✅ 成功
```

---

## ⚠️ 限制和注意事项

### 1. 节点支持限制

**不支持真实执行的节点：**
- ChatModel（需要AI服务）
- Tool（需要工具实现）
- HTTP Request（需要网络）
- Webhook（需要外部触发）
- Retriever（需要数据库）

这些节点会返回模拟结果。

### 2. 执行环境限制

- Lambda代码在浏览器环境执行
- 不能访问Node.js特定API
- 不能执行异步操作（Promise）
- 不能访问文件系统

### 3. 性能限制

- 每个节点执行有500ms延迟（模拟）
- 复杂工作流可能需要较长时间
- 大数据量可能导致浏览器卡顿

### 4. 安全限制

- 使用Function构造函数执行代码
- 仅用于测试，不要执行不信任的代码
- 生产环境应使用后端执行

---

## 🚀 高级功能

### 1. 变量跟踪

测试结果中包含完整的变量状态：

```json
{
  "variables": {
    "user_name": "Alice",
    "user_score": 85,
    "threshold": 80,
    "result": "pass"
  }
}
```

### 2. 节点执行详情

查看每个节点的详细执行信息：

```json
{
  "nodeResults": {
    "node_1": {
      "variable": "user_score",
      "value": 85
    },
    "node_2": {
      "conditionMet": true,
      "branch": "if"
    }
  }
}
```

### 3. 执行顺序

测试会按照拓扑排序执行节点：
1. 找到起始节点（无输入边）
2. 按依赖关系排序
3. 顺序执行每个节点

### 4. 错误定位

失败时会显示具体的错误节点和错误信息，方便快速定位问题。

---

## 📊 测试报告示例

### 成功测试报告

```
工作流: 用户评分系统
测试时间: 2025-12-29 10:30:00

测试输入:
{
  "user": "Alice",
  "score": 85
}

执行结果: ✅ 成功
执行时间: 2.5秒

节点状态:
  ✅ Set Variable - 保存分数
  ✅ If-Else - 判断等级
  ✅ Template - 生成消息

最终输出:
{
  "grade": "B",
  "message": "恭喜 Alice，你的等级是 B"
}

变量状态:
{
  "user_score": 85,
  "grade": "B"
}
```

### 失败测试报告

```
工作流: 数据处理
测试时间: 2025-12-29 10:35:00

测试输入:
{
  "data": "test"
}

执行结果: ❌ 失败
失败节点: Lambda - 数据处理

错误信息:
代码执行错误: input.value is not defined

节点状态:
  ✅ Set Variable - 初始化
  ❌ Lambda - 数据处理

建议:
1. 检查Lambda代码中的变量引用
2. 确保input对象包含value字段
3. 添加错误处理逻辑
```

---

## 🎉 总结

工作流测试功能提供了：

### 核心功能
- ✅ 完整的工作流模拟执行
- ✅ 实时节点状态可视化
- ✅ 详细的执行结果和错误信息
- ✅ 变量状态跟踪
- ✅ 支持8种节点类型的真实执行

### 使用价值
- ✅ 快速验证工作流逻辑
- ✅ 无需创建Agent即可测试
- ✅ 方便调试和排错
- ✅ 提高开发效率
- ✅ 降低试错成本

### 适用场景
- ✅ 工作流开发阶段
- ✅ 逻辑验证
- ✅ 问题排查
- ✅ 性能测试
- ✅ 文档演示

现在你可以放心地测试和调试工作流了！🚀

---

**更新时间：** 2025-12-29  
**版本：** v2.2.0  
**状态：** ✅ 已完成并测试通过

