# 工作流编辑器增强功能文档

## 📋 概述

本次更新大幅增强了工作流编辑器的交互体验和功能，主要包括：
- ✅ ChatModel节点增强 - 完整的API配置和模型选择
- ✅ Tool节点完善 - 内置工具库和自定义工具支持
- ✅ Lambda节点优化 - 大代码编辑器和6个代码模板
- ✅ 新增10种节点类型 - 逻辑、数据处理、集成节点

---

## 🎯 主要功能

### 1. ChatModel节点增强

**新增功能：**
- **API配置选择**：支持选择已配置的API端点
- **AI平台切换**：支持OpenRouter、OpenAI、Anthropic、Google、Meta
- **智能模型搜索**：
  - 实时搜索模型名称和ID
  - 显示模型详细信息（上下文长度、描述）
  - 下拉框选择，体验与Agents页面一致
- **完整参数配置**：
  - Temperature滑块（0-2）
  - Max Tokens输入框（100-8000）

**使用示例：**
```typescript
// ChatModel节点配置
{
  api_config_id: "1",
  model_name: "anthropic/claude-3.5-sonnet",
  temperature: 0.7,
  max_tokens: 2000
}
```

---

### 2. Tool节点完善

**新增功能：**
- **内置工具库**（8个常用工具）：
  - 🔍 网页搜索 (web_search)
  - 🧮 计算器 (calculator)
  - 💻 代码解释器 (code_interpreter)
  - 📁 文件读取 (file_reader)
  - 🎨 图片生成 (image_generator)
  - 🕷️ 网页抓取 (web_scraper)
  - 🗄️ 数据库查询 (database_query)
  - 🌐 API调用 (api_caller)

- **选择工具时自动填充描述**
- **支持自定义工具名称**
- **工具参数配置（JSON格式）**

**使用示例：**
```typescript
// Tool节点配置
{
  tool_name: "web_search",
  description: "搜索互联网获取实时信息",
  parameters: "{\"query\": \"latest AI news\"}"
}
```

---

### 3. Lambda节点优化

**新增功能：**
- **扩大代码编辑器**：从6行增加到16行（400px高度）
- **6个代码模板**：
  1. **空模板** - 基础结构
  2. **文本处理** - 大小写转换、字数统计
  3. **JSON解析** - 安全解析和字段提取
  4. **数据过滤** - 过滤和排序
  5. **API响应格式化** - 标准化API响应
  6. **条件判断** - 多条件逻辑判断

- **代码编辑器优化**：
  - 等宽字体
  - 更好的行高和间距
  - 提示信息

**使用示例：**
```javascript
// Lambda节点 - 文本处理模板
function process(input) {
  const text = input.text || '';
  
  // 转换为大写
  const upperText = text.toUpperCase();
  
  // 统计字数
  const wordCount = text.split(/\s+/).length;
  
  return {
    original: text,
    upper: upperText,
    wordCount: wordCount
  };
}
```

---

### 4. 新增节点类型（10种）

#### 🎯 逻辑控制节点

**Condition（条件判断）**
- 条件表达式配置
- 支持多种条件类型：表达式、等于、大于、小于、包含
```typescript
{
  condition: "input.score > 0.8",
  condition_type: "expression"
}
```

**Loop（循环）**
- 支持For、While、ForEach循环
- 最大迭代次数限制
- 循环条件配置
```typescript
{
  loop_type: "for",
  max_iterations: 10,
  loop_condition: "index < items.length"
}
```

**Switch（多路分支）**
- 根据字段值选择不同路径
- JSON格式配置分支规则
```typescript
{
  switch_field: "status",
  cases: "{\"success\": \"path1\", \"error\": \"path2\"}"
}
```

#### 📊 数据处理节点

**Transform（数据转换）**
- 支持映射、归约、过滤、排序
- 自定义转换函数
```typescript
{
  transform_type: "map",
  transform_function: "(item) => { return item; }"
}
```

**Merge（数据合并）**
- 支持连接、合并、覆盖、深度合并
```typescript
{
  merge_strategy: "deep_merge"
}
```

**Filter（数据过滤）**
- 自定义过滤条件
```typescript
{
  filter_condition: "(item) => item.value > 0"
}
```

**Template（模板渲染）**
- 使用 `{{variable}}` 语法
- 动态内容生成
```typescript
{
  template: "Hello {{name}}, your score is {{score}}"
}
```

#### 🔌 集成节点

**HTTP Request（HTTP请求）**
- 支持GET、POST、PUT、DELETE、PATCH
- 自定义请求头和请求体
```typescript
{
  method: "POST",
  url: "https://api.example.com/endpoint",
  headers: "{\"Content-Type\": \"application/json\"}",
  body: "{\"key\": \"value\"}"
}
```

**Webhook（Webhook触发器）**
- 自定义webhook路径
- 支持多种认证方式：无、Token、Basic Auth、API Key
```typescript
{
  webhook_path: "/webhook/trigger",
  auth_type: "token"
}
```

**Delay（延迟执行）**
- 毫秒级延迟控制
```typescript
{
  delay_ms: 1000
}
```

---

## 🎨 节点分类系统

新增节点分类筛选功能，方便快速找到所需节点：

- **全部** - 显示所有节点
- **核心** - ChatModel、Tool、Lambda、Retriever
- **逻辑** - Condition、Loop、Switch
- **数据** - Transform、Merge、Filter、Template
- **集成** - HTTP Request、Webhook、Delay

---

## 📐 UI/UX改进

### 节点面板
- 分类标签快速筛选
- 节点图标和颜色区分
- 悬停效果增强

### 配置面板
- 响应式布局
- 智能表单验证
- 实时预览
- 提示信息和占位符

### 代码编辑器
- 等宽字体
- 语法高亮准备
- 更大的编辑区域
- 模板快速选择

---

## 🔧 技术实现

### 文件修改清单

1. **frontend/src/components/workflow/NodeConfigPanel.tsx**
   - 新增API配置和模型服务集成
   - 实现8个内置工具
   - 添加6个Lambda代码模板
   - 支持10种新节点类型配置

2. **frontend/src/components/workflow/NodePanel.tsx**
   - 新增10种节点定义
   - 实现分类筛选系统
   - 优化节点展示UI

3. **frontend/src/components/workflow/CustomNode.tsx**
   - 扩展节点类型定义
   - 新增节点图标映射
   - 新增节点颜色方案

### 依赖服务

```typescript
import { apiConfigService } from '../../services/apiConfigService';
import { modelService, Model } from '../../services/modelService';
import { APIConfig } from '../../types';
```

---

## 📊 节点统计

| 类别 | 节点数量 | 节点类型 |
|------|---------|---------|
| 核心 | 4 | ChatModel, Tool, Lambda, Retriever |
| 逻辑 | 3 | Condition, Loop, Switch |
| 数据 | 4 | Transform, Merge, Filter, Template |
| 集成 | 3 | HTTP Request, Webhook, Delay |
| **总计** | **14** | - |

---

## 🎯 使用场景示例

### 场景1：智能客服工作流

```
Start 
  → ChatModel (理解用户问题)
  → Condition (判断问题类型)
    ├─ 简单问题 → Template (生成回复)
    └─ 复杂问题 → Tool (web_search) → ChatModel (综合回答)
  → End
```

### 场景2：数据处理管道

```
Start 
  → HTTP Request (获取数据)
  → Lambda (数据清洗)
  → Filter (过滤无效数据)
  → Transform (数据转换)
  → Loop (批量处理)
  → Merge (合并结果)
  → End
```

### 场景3：API集成工作流

```
Start 
  → Webhook (接收请求)
  → Lambda (参数验证)
  → Switch (路由分发)
    ├─ 路径A → HTTP Request (调用API A)
    ├─ 路径B → HTTP Request (调用API B)
    └─ 默认 → Template (错误响应)
  → End
```

---

## 🚀 快速开始

### 1. 创建ChatModel节点

1. 从节点库拖拽"ChatModel"到画布
2. 点击节点打开配置面板
3. 选择API配置
4. 选择AI平台（如OpenRouter）
5. 搜索并选择模型
6. 调整Temperature和Max Tokens
7. 保存配置

### 2. 创建Tool节点

1. 拖拽"Tool"节点到画布
2. 从下拉框选择内置工具（如"网页搜索"）
3. 工具描述自动填充
4. 可选：修改工具名称或添加参数
5. 保存配置

### 3. 创建Lambda节点

1. 拖拽"Lambda"节点到画布
2. 从模板下拉框选择代码模板
3. 在大代码编辑器中修改代码
4. 设置函数名称
5. 保存配置

### 4. 连接节点

1. 从源节点底部的连接点拖拽
2. 连接到目标节点顶部的连接点
3. 创建工作流

---

## 🔍 配置示例

### 完整工作流配置

```json
{
  "name": "智能问答助手",
  "nodes": [
    {
      "id": "node-1",
      "type": "chatmodel",
      "label": "理解问题",
      "config": {
        "api_config_id": "1",
        "model_name": "anthropic/claude-3.5-sonnet",
        "temperature": 0.7,
        "max_tokens": 2000
      }
    },
    {
      "id": "node-2",
      "type": "tool",
      "label": "网页搜索",
      "config": {
        "tool_name": "web_search",
        "description": "搜索互联网获取实时信息",
        "parameters": "{\"max_results\": 5}"
      }
    },
    {
      "id": "node-3",
      "type": "lambda",
      "label": "结果处理",
      "config": {
        "function_name": "process_results",
        "code": "function process(input) {\n  return input.results.slice(0, 3);\n}"
      }
    }
  ],
  "edges": [
    {
      "source": "node-1",
      "target": "node-2"
    },
    {
      "source": "node-2",
      "target": "node-3"
    }
  ]
}
```

---

## 💡 最佳实践

### 1. ChatModel节点
- 根据任务选择合适的模型
- 创造性任务使用较高Temperature（1.0-1.5）
- 精确任务使用较低Temperature（0.1-0.5）
- 根据需求调整Max Tokens

### 2. Tool节点
- 优先使用内置工具
- 自定义工具时提供清晰的描述
- 使用JSON格式配置复杂参数

### 3. Lambda节点
- 从模板开始，减少编写时间
- 保持函数简洁，单一职责
- 添加错误处理
- 使用注释说明逻辑

### 4. 工作流设计
- 保持工作流简洁，避免过度复杂
- 使用有意义的节点名称
- 合理使用条件和循环节点
- 定期保存工作流

---

## 🐛 已知问题和限制

1. **代码编辑器**：暂不支持语法高亮（计划中）
2. **节点验证**：部分节点配置验证在后端进行
3. **工作流执行**：新节点类型的执行逻辑需要后端支持

---

## 🔮 未来计划

### 短期（1-2周）
- [ ] 代码编辑器语法高亮
- [ ] 节点配置实时验证
- [ ] 更多内置工具
- [ ] 节点配置导入/导出

### 中期（1-2月）
- [ ] 可视化调试功能
- [ ] 节点执行日志
- [ ] 工作流版本控制
- [ ] 协作编辑功能

### 长期（3-6月）
- [ ] AI辅助工作流生成
- [ ] 工作流市场
- [ ] 自定义节点插件系统
- [ ] 性能监控和优化

---

## 📞 技术支持

如有问题或建议，请通过以下方式联系：

- 📧 提交Issue
- 💬 加入社区讨论
- 📖 查看完整文档

---

## 📝 更新日志

### v2.0.0 (2025-12-29)

**新增功能：**
- ✅ ChatModel节点完整API配置和模型选择
- ✅ Tool节点内置工具库（8个工具）
- ✅ Lambda节点代码模板（6个模板）
- ✅ 新增10种节点类型
- ✅ 节点分类筛选系统
- ✅ 优化UI/UX体验

**改进：**
- 📈 代码编辑器从6行扩大到16行
- 🎨 节点图标和颜色系统
- 🔍 智能模型搜索功能
- 📱 响应式配置面板

**修复：**
- 🐛 修复类型冲突问题
- 🐛 优化下拉框交互

---

## 🎉 总结

本次更新大幅提升了工作流编辑器的功能和体验：

- **节点数量**：从4种增加到14种（+250%）
- **内置工具**：新增8个常用工具
- **代码模板**：提供6个Lambda模板
- **配置增强**：ChatModel节点支持完整的API和模型配置
- **分类系统**：4个节点分类，快速查找

现在你可以创建更复杂、更强大的AI工作流！🚀

