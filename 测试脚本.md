# 测试脚本

## 功能测试清单

### 1. 用户认证测试

#### 注册功能
```bash
# 测试注册API
curl -X POST http://localhost:8080/api/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "username": "testuser",
    "email": "test@example.com",
    "password": "password123"
  }'

# 预期结果: 返回用户信息
```

#### 登录功能
```bash
# 测试登录API
curl -X POST http://localhost:8080/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "password123"
  }'

# 预期结果: 返回token和用户信息
# 保存返回的token用于后续测试
TOKEN="返回的token"
```

#### 获取用户信息
```bash
# 测试获取用户信息
curl -X GET http://localhost:8080/api/auth/profile \
  -H "Authorization: Bearer $TOKEN"

# 预期结果: 返回当前用户信息
```

### 2. API配置测试

#### 创建API配置
```bash
curl -X POST http://localhost:8080/api/configs \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "OpenRouter配置",
    "api_type": "openrouter",
    "endpoint_url": "https://openrouter.ai/api/v1/chat/completions",
    "auth_type": "bearer",
    "credentials": "your-api-key-here",
    "is_active": true
  }'

# 保存返回的配置ID
CONFIG_ID="返回的id"
```

#### 获取API配置列表
```bash
curl -X GET http://localhost:8080/api/configs \
  -H "Authorization: Bearer $TOKEN"
```

### 3. 智能体测试

#### 创建智能体
```bash
curl -X POST http://localhost:8080/api/agents \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "测试助手",
    "description": "一个测试用的AI助手",
    "system_prompt": "你是一个友好的AI助手",
    "api_config_id": '$CONFIG_ID',
    "model_name": "anthropic/claude-3.5-sonnet",
    "model_params": {
      "temperature": 0.7,
      "max_tokens": 2000
    },
    "is_public": false
  }'

# 保存返回的智能体ID
AGENT_ID="返回的id"
```

#### 获取智能体列表
```bash
curl -X GET http://localhost:8080/api/agents \
  -H "Authorization: Bearer $TOKEN"
```

### 4. 对话测试

#### 创建对话
```bash
curl -X POST http://localhost:8080/api/conversations \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "agent_id": '$AGENT_ID',
    "title": "测试对话"
  }'

# 保存返回的对话ID
CONVERSATION_ID="返回的id"
```

#### 发送消息
```bash
curl -X POST http://localhost:8080/api/conversations/$CONVERSATION_ID/messages \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "content": "你好，请介绍一下你自己"
  }'
```

#### 获取对话消息
```bash
curl -X GET http://localhost:8080/api/conversations/$CONVERSATION_ID/messages \
  -H "Authorization: Bearer $TOKEN"
```

### 5. 统计测试

#### 获取使用统计
```bash
curl -X GET http://localhost:8080/api/usage/stats \
  -H "Authorization: Bearer $TOKEN"
```

#### 获取每日统计
```bash
curl -X GET "http://localhost:8080/api/usage/daily?days=7" \
  -H "Authorization: Bearer $TOKEN"
```

#### 按智能体统计
```bash
curl -X GET http://localhost:8080/api/usage/by-agent \
  -H "Authorization: Bearer $TOKEN"
```

---

## 前端功能测试

### 1. 注册和登录
1. 访问 http://localhost:3000/register
2. 填写用户名、邮箱、密码
3. 点击注册
4. 跳转到登录页面
5. 输入邮箱和密码
6. 点击登录
7. 应该进入主界面

### 2. API配置
1. 点击侧边栏"API配置"
2. 点击"添加配置"
3. 填写配置信息
4. 保存
5. 应该在列表中看到新配置

### 3. 创建智能体
1. 点击侧边栏"智能体"
2. 点击"创建智能体"
3. 填写智能体信息
4. 选择API配置和模型
5. 保存
6. 应该在列表中看到新智能体

### 4. 开始对话
1. 点击侧边栏"对话"
2. 点击"新建对话"
3. 选择智能体
4. 创建
5. 输入消息
6. 发送
7. 应该收到AI回复

### 5. 查看统计
1. 点击侧边栏"使用统计"
2. 应该看到统计卡片
3. 应该看到使用趋势图
4. 应该看到按智能体统计表格

---

## 性能测试

### 并发测试
```bash
# 安装Apache Bench
# macOS: brew install httpd
# Ubuntu: sudo apt-get install apache2-utils

# 测试登录接口性能
ab -n 1000 -c 10 -p login.json -T application/json \
  http://localhost:8080/api/auth/login

# login.json内容:
# {"email":"test@example.com","password":"password123"}
```

### 压力测试
```bash
# 使用wrk进行压力测试
# 安装: brew install wrk

wrk -t4 -c100 -d30s http://localhost:8080/health
```

---

## 数据库测试

### 检查数据
```sql
-- 登录MySQL
mysql -u root -p ai_chat

-- 查看用户
SELECT * FROM users;

-- 查看智能体
SELECT * FROM agents;

-- 查看对话
SELECT * FROM conversations;

-- 查看消息
SELECT * FROM messages;

-- 查看Token统计
SELECT * FROM token_usages;

-- 查看API配置
SELECT * FROM api_configs;
```

### 数据完整性检查
```sql
-- 检查外键关系
SELECT 
    TABLE_NAME,
    CONSTRAINT_NAME,
    REFERENCED_TABLE_NAME
FROM 
    INFORMATION_SCHEMA.KEY_COLUMN_USAGE
WHERE 
    TABLE_SCHEMA = 'ai_chat'
    AND REFERENCED_TABLE_NAME IS NOT NULL;

-- 检查索引
SHOW INDEX FROM users;
SHOW INDEX FROM agents;
SHOW INDEX FROM conversations;
SHOW INDEX FROM messages;
```

---

## 错误场景测试

### 1. 无效的Token
```bash
curl -X GET http://localhost:8080/api/auth/profile \
  -H "Authorization: Bearer invalid_token"

# 预期: 401 Unauthorized
```

### 2. 缺少必填字段
```bash
curl -X POST http://localhost:8080/api/agents \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "description": "缺少name字段"
  }'

# 预期: 400 Bad Request
```

### 3. 访问不存在的资源
```bash
curl -X GET http://localhost:8080/api/agents/99999 \
  -H "Authorization: Bearer $TOKEN"

# 预期: 404 Not Found
```

### 4. 无权访问他人资源
```bash
# 使用另一个用户的token访问第一个用户的智能体
curl -X DELETE http://localhost:8080/api/agents/$AGENT_ID \
  -H "Authorization: Bearer $OTHER_USER_TOKEN"

# 预期: 403 Forbidden
```

---

## 自动化测试脚本

创建 `test.sh`:

```bash
#!/bin/bash

BASE_URL="http://localhost:8080/api"

# 颜色输出
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

echo "开始测试..."

# 1. 测试健康检查
echo -n "测试健康检查... "
response=$(curl -s http://localhost:8080/health)
if [[ $response == *"ok"* ]]; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
fi

# 2. 测试注册
echo -n "测试用户注册... "
response=$(curl -s -X POST $BASE_URL/auth/register \
    -H "Content-Type: application/json" \
    -d '{"username":"test","email":"test@test.com","password":"123456"}')
if [[ $response == *"username"* ]]; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
fi

# 3. 测试登录
echo -n "测试用户登录... "
response=$(curl -s -X POST $BASE_URL/auth/login \
    -H "Content-Type: application/json" \
    -d '{"email":"test@test.com","password":"123456"}')
if [[ $response == *"token"* ]]; then
    TOKEN=$(echo $response | grep -o '"token":"[^"]*' | cut -d'"' -f4)
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
    exit 1
fi

# 4. 测试获取用户信息
echo -n "测试获取用户信息... "
response=$(curl -s -X GET $BASE_URL/auth/profile \
    -H "Authorization: Bearer $TOKEN")
if [[ $response == *"username"* ]]; then
    echo -e "${GREEN}✓${NC}"
else
    echo -e "${RED}✗${NC}"
fi

echo "测试完成！"
```

使用方法:
```bash
chmod +x test.sh
./test.sh
```

---

## 测试结果记录

| 测试项 | 状态 | 备注 |
|--------|------|------|
| 用户注册 | ✓ | |
| 用户登录 | ✓ | |
| 创建API配置 | ✓ | |
| 创建智能体 | ✓ | |
| 创建对话 | ✓ | |
| 发送消息 | ✓ | |
| 获取统计 | ✓ | |
| 流式响应 | ✓ | |

---

**所有测试通过即可上线！** ✅

